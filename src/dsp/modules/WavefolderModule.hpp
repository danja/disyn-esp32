#pragma once

#include <array>

namespace flues::disyn {

class WavefolderModule {
public:
    float process(float input, float amount) const {
        if (amount <= 0.0f) {
            return input;
        }
        if (amount > 1.0f) {
            amount = 1.0f;
        }
        amount *= amount;

        float x = input * (1.0f + amount * 0.5f);
        if (x < kTableMin) {
            x = kTableMin;
        } else if (x > kTableMax) {
            x = kTableMax;
        }

        float indexFloat = (x - kTableMin) * kTableScale;
        int index = static_cast<int>(indexFloat + 0.5f);
        float folded = kFoldTable[static_cast<std::size_t>(index)];
        float mixed = input + (folded - input) * amount;
        return mixed * (1.0f - amount * 0.2f);
    }

private:
    static constexpr float kTableMin = -2.0f;
    static constexpr float kTableMax = 2.0f;
    static constexpr float kTableScale = 64.0f;
    static constexpr std::size_t kTableSize = 257;
    static constexpr std::array<float, kTableSize> kFoldTable = {{
        0.000000f, -0.015625f, -0.031250f, -0.046875f, -0.062500f, -0.078125f, -0.093750f, -0.109375f,
        -0.125000f, -0.140625f, -0.156250f, -0.171875f, -0.187500f, -0.203125f, -0.218750f, -0.234375f,
        -0.250000f, -0.265625f, -0.281250f, -0.296875f, -0.312500f, -0.328125f, -0.343750f, -0.359375f,
        -0.375000f, -0.390625f, -0.406250f, -0.421875f, -0.437500f, -0.453125f, -0.468750f, -0.484375f,
        -0.500000f, -0.515625f, -0.531250f, -0.546875f, -0.562500f, -0.578125f, -0.593750f, -0.609375f,
        -0.625000f, -0.640625f, -0.656250f, -0.671875f, -0.687500f, -0.703125f, -0.718750f, -0.734375f,
        -0.750000f, -0.765625f, -0.781250f, -0.796875f, -0.812500f, -0.828125f, -0.843750f, -0.859375f,
        -0.875000f, -0.890625f, -0.906250f, -0.921875f, -0.937500f, -0.953125f, -0.968750f, -0.984375f,
        -1.000000f, -0.984375f, -0.968750f, -0.953125f, -0.937500f, -0.921875f, -0.906250f, -0.890625f,
        -0.875000f, -0.859375f, -0.843750f, -0.828125f, -0.812500f, -0.796875f, -0.781250f, -0.765625f,
        -0.750000f, -0.734375f, -0.718750f, -0.703125f, -0.687500f, -0.671875f, -0.656250f, -0.640625f,
        -0.625000f, -0.609375f, -0.593750f, -0.578125f, -0.562500f, -0.546875f, -0.531250f, -0.515625f,
        -0.500000f, -0.484375f, -0.468750f, -0.453125f, -0.437500f, -0.421875f, -0.406250f, -0.390625f,
        -0.375000f, -0.359375f, -0.343750f, -0.328125f, -0.312500f, -0.296875f, -0.281250f, -0.265625f,
        -0.250000f, -0.234375f, -0.218750f, -0.203125f, -0.187500f, -0.171875f, -0.156250f, -0.140625f,
        -0.125000f, -0.109375f, -0.093750f, -0.078125f, -0.062500f, -0.046875f, -0.031250f, -0.015625f,
        0.000000f, 0.015625f, 0.031250f, 0.046875f, 0.062500f, 0.078125f, 0.093750f, 0.109375f,
        0.125000f, 0.140625f, 0.156250f, 0.171875f, 0.187500f, 0.203125f, 0.218750f, 0.234375f,
        0.250000f, 0.265625f, 0.281250f, 0.296875f, 0.312500f, 0.328125f, 0.343750f, 0.359375f,
        0.375000f, 0.390625f, 0.406250f, 0.421875f, 0.437500f, 0.453125f, 0.468750f, 0.484375f,
        0.500000f, 0.515625f, 0.531250f, 0.546875f, 0.562500f, 0.578125f, 0.593750f, 0.609375f,
        0.625000f, 0.640625f, 0.656250f, 0.671875f, 0.687500f, 0.703125f, 0.718750f, 0.734375f,
        0.750000f, 0.765625f, 0.781250f, 0.796875f, 0.812500f, 0.828125f, 0.843750f, 0.859375f,
        0.875000f, 0.890625f, 0.906250f, 0.921875f, 0.937500f, 0.953125f, 0.968750f, 0.984375f,
        1.000000f, 0.984375f, 0.968750f, 0.953125f, 0.937500f, 0.921875f, 0.906250f, 0.890625f,
        0.875000f, 0.859375f, 0.843750f, 0.828125f, 0.812500f, 0.796875f, 0.781250f, 0.765625f,
        0.750000f, 0.734375f, 0.718750f, 0.703125f, 0.687500f, 0.671875f, 0.656250f, 0.640625f,
        0.625000f, 0.609375f, 0.593750f, 0.578125f, 0.562500f, 0.546875f, 0.531250f, 0.515625f,
        0.500000f, 0.484375f, 0.468750f, 0.453125f, 0.437500f, 0.421875f, 0.406250f, 0.390625f,
        0.375000f, 0.359375f, 0.343750f, 0.328125f, 0.312500f, 0.296875f, 0.281250f, 0.265625f,
        0.250000f, 0.234375f, 0.218750f, 0.203125f, 0.187500f, 0.171875f, 0.156250f, 0.140625f,
        0.125000f, 0.109375f, 0.093750f, 0.078125f, 0.062500f, 0.046875f, 0.031250f, 0.015625f,
        0.000000f
    }};
};

} // namespace flues::disyn
